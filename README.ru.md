# Radar ONE  
Информационная система оперативного мониторинга угроз

## README Languages / Языки README

README доступен на этих языках:
- [English / Английский](README.md)
- [Russian / Русский](README.ru.md)

## Содержание

1. [Общая характеристика системы](#1-общая-характеристика-системы)
2. [Архитектура системы](#2-архитектура-системы)
3. [Принцип работы системы](#3-принцип-работы-системы)
   - [3.1 Получение сообщений](#31-получение-сообщений)
   - [3.2 Предварительная фильтрация](#32-предварительная-фильтрация)
   - [3.3 Классификация сообщений](#33-классификация-сообщений)
   - [3.4 Обработка результатов анализа](#34-обработка-результатов-анализа)
   - [3.5 Сохранение данных](#35-сохранение-данных)
   - [3.6 Telegram-бот](#36-telegram-бот)
   - [3.7 HTTP API](#37-http-api)
   - [3.8 WebSocket](#38-websocket)
   - [3.9 Клиентская часть](#39-клиентская-часть)
4. [Структура проекта](#4-структура-проекта)
5. [Порядок внесения изменений](#5-порядок-внесения-изменений)
   - [5.1 Общие правила](#51-общие-правила)
   - [5.2 Изменение логики классификации](#52-изменение-логики-классификации)
   - [5.3 Добавление нового региона](#53-добавление-нового-региона)
   - [5.4 Добавление нового типа угрозы](#54-добавление-нового-типа-угрозы)
   - [5.5 Изменение Telegram-бота](#55-изменение-telegram-бота)
   - [5.6 Порядок тестирования](#56-порядок-тестирования)
6. [Требования к коммитам](#6-требования-к-коммитам)
7. [Контрольный список перед внесением изменений](#7-контрольный-список-перед-внесением-изменений)
8. [Логирование](#8-логирование)
9. [Дополнительная информация](#9-дополнительная-информация)
10. [Лицензирование](#10-лицензирование)

## 1. Общая характеристика системы

Radar ONE - информационная система, предназначенная для автоматизированного мониторинга Telegram-каналов, классификации сообщений об угрозах и предоставления агрегированной информации пользователям через:

- Telegram-бота: https://t.me/radaronebot  
- Интерактивную онлайн-карту: https://radarone.online  
- HTTP API
- WebSocket-соединение  

Система реализована на языке Python с использованием асинхронной архитектуры и базы данных PostgreSQL.

## 2. Архитектура системы

Система состоит из следующих логических компонентов:

```
+-----------------+
| Telegram-каналы |
+--------+--------+
         |
         V
+--------+--------+         +-------------------+
|   listener.py   | <-----> | analyzer.py (LLM) |
+--------+--------+         +-------------------+
         |
         |       +--------------+
         +-----> | Telegram-бот |
         |       +--------------+
         |
         |       +---------------------+
         +-----> | db.py  (PostgreSQL) |
                 +----------+----------+
                            |
                            V
                 +----------+----------+
                 |   FastAPI backend   |
                 +----------+----------+
                            |
                            |       +---------------------------+
                            +-----> | HTTP API  (/api/statuses) |
                            |       +---------------------------+
                            |
                            |       +-----------------+
                            +-----> | WebSocket (/ws) |
                                    +--------+--------+
                                             |
                                             V
                                    +--------+--------+
                                    |   Онлайн-карта  |
                                    +-----------------+
```

Все компоненты серверной части работают в рамках единого асинхронного цикла событий asyncio.

## 3. Принцип работы системы

### 3.1 Получение сообщений

Модуль `listener.py` выполняет:

- асинхронный опрос Telegram-каналов из списка `TELEGRAM_CHANNELS`;
- получение HTML-страницы канала через aiohttp;
- извлечение последнего сообщения с использованием BeautifulSoup;
- исключение дублирующихся сообщений;
- передачу нового сообщения в обработчик `process_message()`.

Интервал опроса по умолчанию составляет 10 секунд.

### 3.2 Предварительная фильтрация

Функция `preprocess_message()`:

- выполняет фильтрацию сообщений по списку запрещённых слов (`BANWORDS`);
- исключает нерелевантные сообщения до передачи в модуль анализа.

### 3.3 Классификация сообщений

Классификация выполняется функцией `analyze_message()` модуля `analyzer.py` с использованием LLM:

- OpenAI (при наличии `OPENAI_API_KEY`);
- Ollama (при наличии `OLLAMA_MODEL` и `OLLAMA_API_KEY` и ошибке при попытке использования OpenAI).

Модели возвращают результат в формате:

```
(уровень угрозы)/(регион)/(тип угрозы)
```

При наличии нескольких событий результат содержит несколько записей через запятую:

```
(уровень угрозы 1)/(регион 1)/(тип угрозы 1),(уровень угрозы 2)/(регион 2)/(тип угрозы 2)
```

### 3.4 Обработка результатов анализа

Функция `process_message()`:

- разделяет результат LLM на составные части;
- нормализует регион через `normalize_region()`;
- проверяет допустимость типа угрозы;
- формирует список целевых обновлений через `expand_targets()`;
- вызывает `handle_attack_update()` для каждого события.

### 3.5 Сохранение данных

Модуль `db.py` обеспечивает:

- асинхронное подключение к PostgreSQL через asyncpg;
- хранение данных в таблицах:
  - `attacks`
  - `subscriptions`
- проверку изменения статуса перед сохранением;
- механизм LISTEN / NOTIFY для мгновенной доставки обновлений;
- управление подписками пользователей.

При вставке новой записи автоматически отправляется уведомление в канал `attack_updates`.

### 3.6 Telegram-бот

Telegram-бот реализован с использованием библиотеки `python-telegram-bot` в режиме polling.

Основные функции:

- получение текущего статуса региона (`/status`);
- управление подписками (`/subscribe`, `/unsubscribe`, `/subscriptions`);
- приём пользовательских сообщений (`/report`) с последующей модерацией;
- административные команды (`/ban`, `/unban`, `/is_banned`, `/admin_message`, `/admin_report`).

Бот использует отдельный пул соединений к базе данных.

### 3.7 HTTP API

Endpoint:

```
GET /api/statuses/
```

Возвращает агрегированное состояние всех регионов в формате JSON.

Используется:
- для первичной инициализации карты;
- при восстановлении соединения.

### 3.8 WebSocket

Endpoint:

```
/ws/
```

Функции:

- хранение активных соединений;
- отправка snapshot при подключении;
- рассылка обновлений при получении уведомления из PostgreSQL;
- автоматическое переподключение на стороне клиента.

### 3.9 Клиентская часть

Веб-интерфейс реализован с использованием:

- MapTiler / OpenStreetMap;
- MapLibre GL / Leaflet;
- GeoJSON-данных регионов РФ.

Каждому региону сопоставляется цвет, отражающий суммарный уровень угроз.

## 4. Структура проекта

Основные модули:

- main.py - инициализация FastAPI, WebSocket, listener и бота;
- listener.py - сбор сообщений;
- analyzer.py - взаимодействие с LLM;
- db.py - работа с PostgreSQL;
- bot.py - логика Telegram-бота;
- logger.py - централизованное логирование;
- frontend/ - клиентская часть;
- docker-compose.yml - конфигурация контейнеров;
- .env.example - пример конфигурации переменных окружения.

## 5. Порядок внесения изменений

### 5.1 Общие правила

- Все изменения вносятся непосредственно в ветку `main`.
- Перед внесением изменений рекомендуется локальное тестирование.
- Недопустимо внесение изменений, нарушающих формат ответа LLM или структуру базы данных без проверки совместимости.

### 5.2 Изменение логики классификации

При модификации `analyzer.py` необходимо:

- сохранить формат итогового ответа модели;
- обеспечить корректную обработку нескольких событий;
- проверить совместимость с `process_message()`.

Изменение шаблона запроса к LLM должно:

- сохранять строгую структуру ответа;
- исключать свободный текст вне установленного формата;
- учитывать полный список регионов РФ.

### 5.3 Добавление нового региона

Требуется:

- добавить регион в конфигурационный список;
- при необходимости обновить соответствие названий;
- проверить корректность отображения на карте;
- проверить корректность обработки подписок.

### 5.4 Добавление нового типа угрозы

Необходимо:

- обновить допустимые типы угроз;
- обновить визуализацию на карте;
- проверить формат уведомлений Telegram-бота;
- проверить агрегацию статусов.

### 5.5 Изменение Telegram-бота

Перед изменением:

- проверить влияние на базу данных;
- убедиться в корректности прав администратора;
- протестировать сценарии подписки и модерации.

### 5.6 Порядок тестирования

Рекомендуется проверять:

1. Получение сообщения из Telegram-канала.
2. Корректность классификации.
3. Сохранение записи в БД.
4. Генерацию уведомления.
5. Обновление WebSocket.
6. Отображение изменений на карте.
7. Корректность работы Telegram-бота.

Тестирование должно включать:
- сценарии с одним событием;
- сценарии с несколькими событиями;
- сообщения с запрещёнными словами;
- повторные сообщения.

## 6. Требования к коммитам

Коммиты должны:

- содержать краткое и точное описание изменения;
- отражать суть изменения (например: "fix LLM parsing", "add region normalization");
- не объединять несвязанные изменения в одном коммите;
- не содержать временных отладочных конструкций.

## 7. Контрольный список перед внесением изменений

Перед публикацией изменений необходимо проверить:

- корректность синтаксиса и отсутствие ошибок;
- сохранение формата ответа LLM;
- отсутствие дублирования записей в БД;
- корректность WebSocket-обновлений;
- корректность отображения на карте;
- отсутствие нарушений логирования;
- отсутствие конфиденциальных данных в коде.

## 8. Логирование

Логирование реализовано через стандартный модуль logging.

Используются уровни:

- INFO
- WARNING
- ERROR

Ротация файлов осуществляется ежедневно. Хранится до 30 архивных файлов.

## 9. Дополнительная информация

Система рассчитана на непрерывную работу в асинхронном режиме и требует соблюдения форматов взаимодействия между компонентами. Изменения в одном модуле должны проверяться на совместимость со всеми остальными компонентами системы.

## 10. Лицензирование

Проект распространяется под лицензией MIT. Полный текст лицензии находится в файле [LICENSE](LICENSE)
